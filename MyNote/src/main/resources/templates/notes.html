<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyNote我的筆記-內頁</title>
    <!-- 載入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 Inter 字體 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* 確保全域使用 Inter 字體 */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* 隱藏捲軸，保持介面簡潔 */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        /* 確保 textarea 不會被使用者拉伸導致佈局破壞 */
        textarea {
            resize: none;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- 應用程式主容器 -->
    <div id="app-container">
        <!-- 內容將由 JavaScript 渲染 -->
    </div>

    <script>
        // --- 狀態管理 ---
        // 從 localStorage 讀取使用者
        let user = JSON.parse(localStorage.getItem('user'));
        
        //筆記清單
        let notes = [];
        let activeNoteId = null;

        const appContainer = document.getElementById('app-container');

        // 如果沒有登入，跳轉回登入頁
        if (!user) {
            window.location.href = '/login';
        }

        // --- 工具函數：Lucide Icon SVG ---
        // 使用 inline SVG 替換 Lucide React Component
        const getIcon = (iconName, size = 20, className = '') => {
            const icons = {
                'LogOut': `<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/>`,
                'FileText': `<path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><line x1="16" x2="16" y1="10" y2="10"/><line x1="16" x2="16" y1="14" y2="14"/><line x1="10" x2="10" y1="18" y2="18"/>`,
                'ArrowRight': `<line x1="5" x2="19" y1="12" y2="12"/><polyline points="12 5 19 12 12 19"/>`,
                'Plus': `<line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/>`,
                'Trash2': `<path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 2v2a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1V2"/>`,
                'Save': `<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>`,
                'ChevronLeft': `<polyline points="15 18 9 12 15 6"/>`, // Used for mobile back button
                'FolderPlus': `<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/><line x1="12" x2="12" y1="11" y2="17"/><line x1="9" x2="15" y1="14" y2="14"/>`,
                'Calendar': `<path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/>`,
                'Clock': `<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>`
            };
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}">${icons[iconName] || ''}</svg>`;
            return svg;
        };

        // --- 核心邏輯 ---

        // 模擬登出
        function handleLogout() {
            user = null;
            activeNoteId = null;
            // 清除 localStorage
            localStorage.removeItem('user');
            window.location.href = '/login';
        }

        // 取得今天的日期字串
        function getTodayString() {
            return new Date().toISOString().split('T')[0];
        }

        // 創建新筆記
        function createNote() {
            const newNote = {
                id: Date.now(),
                title: '無標題筆記',
                content: '',
                createdAt: getTodayString(),
                updatedAt: getTodayString()
            };
            //新增筆記
            fetch("http://localhost:8080/api/notes", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(newNote)
            })
            .then(res => res.json())
            .then(data => {
                notes.unshift(data);  // 後端回傳的筆記
                activeNoteId = data.id;
                renderMainApp();
            });
        }

        //刪除筆記
        function handleDeleteNote() {
            if (!activeNoteId) return;

            if (confirm('確定要刪除這則筆記嗎？')) {
                fetch("http://localhost:8080/api/notes/" + activeNoteId, {
                    method: "DELETE"
                })
                .then(() => {
                    // 後端刪除成功後，再更新前端陣列
                    notes = notes.filter(n => n.id !== activeNoteId);
                    activeNoteId = null;
                    renderMainApp();
                })
                .catch(err => {
                    console.error("刪除失敗:", err);
                    alert("刪除失敗，請稍後再試");
                });
            }
        }
        
        //儲存筆記
        function handleSave() {
            if (activeNoteId) {
                const title = document.getElementById('note-title').value;
                const content = document.getElementById('note-content').value;

                const noteToUpdate = notes.find(n => n.id === activeNoteId);
                if (noteToUpdate) {
                    noteToUpdate.title = title;
                    noteToUpdate.content = content;
                    noteToUpdate.updatedAt = getTodayString();

                    // 呼叫後端 API 更新
                    fetch("http://localhost:8080/api/notes/" + activeNoteId, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(noteToUpdate)
                    })
                    .then(res => res.json())
                    .then(data => {
                        // 更新前端 notes 陣列
                        const idx = notes.findIndex(n => n.id === activeNoteId);
                        if (idx !== -1) notes[idx] = data;

                        renderMainApp();

                        // UI 提示
                        const saveBtn = document.getElementById('save-button');
                        if (saveBtn) {
                            const originalText = saveBtn.innerHTML;
                            saveBtn.innerHTML = `儲存成功!`;
                            saveBtn.classList.add('bg-green-600');
                            setTimeout(() => {
                                saveBtn.innerHTML = originalText;
                                saveBtn.classList.remove('bg-green-600');
                            }, 1500);
                        }
                    })
                    .catch(err => console.error("更新失敗:", err));
                }
            }
        }

        // 渲染筆記清單
        function renderNoteList() {
            let listHTML = '';
            if (notes.length === 0) {
                listHTML = `
                    <div class="text-center text-gray-400 mt-20">
                        ${getIcon('FileText', 48, 'mx-auto mb-3 opacity-20')}
                        <p>目前沒有筆記</p>
                    </div>
                `;
            } else {
                listHTML = notes.map(note => {
                    const isActive = note.id === activeNoteId;
                    return `
                        <div 
                            data-note-id="${note.id}"
                            class="p-4 rounded-xl cursor-pointer transition-all hover:shadow-sm border-2 ${
                                isActive 
                                ? 'bg-white shadow border-blue-500' 
                                : 'bg-white border-transparent hover:border-gray-200'
                            }"
                        >
                            <h3 class="font-bold text-base mb-1 truncate ${isActive ? 'text-blue-700' : 'text-gray-800'}">
                                ${note.title || '未命名筆記'}
                            </h3>
                            <p class="text-xs text-gray-500 line-clamp-2 h-8 mb-3">
                                ${note.content || '無內容...'}
                            </p>
                            
                            <div class="flex flex-col gap-1 border-t border-gray-100 pt-2">
                                <div class="flex items-center text-[10px] text-gray-400">
                                    ${getIcon('Calendar', 10, 'mr-1')}
                                    <span class="mr-1">建立:</span>
                                    <span>${note.createdAt}</span>
                                </div>
                                <div class="flex items-center text-[10px] text-gray-400">
                                    ${getIcon('Clock', 10, 'mr-1')}
                                    <span class="mr-1">修改:</span>
                                    <span>${note.updatedAt}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // 渲染左側欄位
            return `
                <div id="note-list-column" class="
                    w-full md:w-80 border-r border-gray-200 bg-gray-50 flex flex-col h-full
                    ${activeNoteId ? 'hidden md:flex' : ''} hide-scrollbar
                ">
                    <!-- Header -->
                    <div class="p-5 border-b border-gray-200 bg-white flex items-center justify-between">
                        <h1 class="text-xl font-bold text-gray-800 tracking-tight">MyNote</h1>
                        <button id="logout-button" class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="登出">
                            ${getIcon('LogOut', 20)}
                        </button>
                    </div>

                    <!-- Note List Content -->
                    <div id="note-list-content" class="flex-1 overflow-y-auto p-3 space-y-2 hide-scrollbar">
                        ${listHTML}
                    </div>

                    <!-- Footer Actions -->
                    <div class="p-4 border-t border-gray-200 bg-white flex items-center gap-2">
                        <button id="create-note-button" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2.5 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors shadow-lg font-bold">
                            ${getIcon('Plus', 18)}
                            <span>新增筆記</span>
                        </button>
                        
                        <button 
                            id="delete-note-button"
                            class="p-2.5 rounded-lg border transition-colors ${
                                activeNoteId 
                                ? 'border-red-200 text-red-500 hover:bg-red-50 hover:border-red-300' 
                                : 'border-gray-200 text-gray-300 cursor-not-allowed'
                            }"
                            title="${activeNoteId ? '刪除目前選中的筆記' : '請先選擇筆記'}"
                            ${!activeNoteId ? 'disabled' : ''}
                        >
                            ${getIcon('Trash2', 20)}
                        </button>
                    </div>
                </div>
            `;
        }

        // 渲染編輯器
        function renderEditor() {
            const note = notes.find(n => n.id === activeNoteId);
            
            if (!note) {
                // Empty State
                return `
                    <div class="flex-1 flex flex-col items-center justify-center text-gray-300 bg-white">
                        <div class="w-24 h-24 bg-gray-50 rounded-full flex items-center justify-center mb-4">
                            ${getIcon('FolderPlus', 40, 'text-gray-300')}
                        </div>
                        <p class="text-lg font-medium text-gray-400">歡迎使用 MyNote</p>
                        <p class="text-sm mt-2 text-gray-400">
                            請從左側列表選擇筆記，或建立新筆記。
                        </p>
                    </div>
                `;
            }

            return `
                <div class="flex-1 flex flex-col bg-white h-full relative">
                    <!-- Editor Toolbar -->
                    <div class="h-16 border-b border-gray-100 flex items-center justify-between px-4 md:px-8 shrink-0">
                        
                        <div class="flex items-center">
                            <!-- Mobile Back Button -->
                            <button 
                                id="mobile-back-button"
                                class="md:hidden mr-3 text-gray-500"
                            >
                                ${getIcon('ChevronLeft', 24)}
                            </button>
                        </div>

                        <button 
                            id="save-button"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg flex items-center gap-2 text-sm font-bold transition-all shadow-md hover:shadow-lg active:scale-95"
                        >
                            ${getIcon('Save', 16)}
                            <span>儲存</span>
                        </button>
                    </div>

                    <!-- Editor Inputs -->
                    <div class="flex-1 overflow-y-auto hide-scrollbar">
                        <div class="max-w-3xl mx-auto px-4 md:px-8 py-8">
                            <input
                                type="text"
                                id="note-title"
                                value="${note.title}"
                                placeholder="筆記標題"
                                class="w-full text-3xl md:text-4xl font-bold text-gray-800 placeholder-gray-300 border-none outline-none bg-transparent mb-6"
                            />
                            <textarea
                                id="note-content"
                                placeholder="開始輸入內容..."
                                class="w-full h-[calc(100vh-250px)] text-lg leading-relaxed text-gray-700 placeholder-gray-300 border-none outline-none bg-transparent"
                            >${note.content}</textarea>
                        </div>
                    </div>
                </div>
            `;
        }

        // 渲染主介面
        function renderMainApp() {
            appContainer.className = "flex h-screen bg-gray-100 overflow-hidden font-sans text-gray-800";
            
            const listHTML = renderNoteList();
            const editorHTML = renderEditor();

            appContainer.innerHTML = `
                ${listHTML}
                <div id="editor-column" class="
                    flex-1 flex flex-col bg-white h-full relative
                    ${!activeNoteId ? 'hidden md:flex' : ''}
                ">
                    ${editorHTML}
                </div>
            `;

            // --- 綁定主介面事件 ---

            // 1. 登出
            document.getElementById('logout-button').addEventListener('click', handleLogout);

            // 2. 新增筆記
            document.getElementById('create-note-button').addEventListener('click', createNote);

            // 3. 刪除筆記
            document.getElementById('delete-note-button').addEventListener('click', handleDeleteNote);

            // 4. 筆記清單點擊
            document.getElementById('note-list-content').querySelectorAll('[data-note-id]').forEach(el => {
                el.addEventListener('click', function() {
                    const noteId = Number(this.getAttribute('data-note-id'));
                    activeNoteId = noteId;
                    renderMainApp();
                });
            });

            // 5. 編輯器相關事件 (只有在有選中筆記時才綁定)
            if (activeNoteId) {
                // 儲存
                document.getElementById('save-button').addEventListener('click', handleSave);

                // 手機版返回
                const mobileBackButton = document.getElementById('mobile-back-button');
                if (mobileBackButton) {
                    mobileBackButton.addEventListener('click', () => {
                        activeNoteId = null;
                        renderMainApp();
                    });
                }
                
                // 編輯內容（模擬即時更新）
                const titleInput = document.getElementById('note-title');
                const contentTextarea = document.getElementById('note-content');
                
                // 為了簡單起見，這裡的修改會直接更新 DOM，但需要手動觸發儲存
                // 綁定 input 事件，確保下次渲染時值是最新的
                titleInput.addEventListener('input', (e) => {
                    const noteToUpdate = notes.find(n => n.id === activeNoteId);
                    if (noteToUpdate) {
                        noteToUpdate.title = e.target.value;
                    }
                });

                contentTextarea.addEventListener('input', (e) => {
                    const noteToUpdate = notes.find(n => n.id === activeNoteId);
                    if (noteToUpdate) {
                        noteToUpdate.content = e.target.value;
                    }
                });
            }
        }

        // 初始化應用程式
        window.onload = function() {
            if (user) {
                // 登入後呼叫後端API (原本在 handleLogin，現在移到這裡)
                fetch("http://localhost:8080/api/notes")
                    .then(res => res.json())
                    .then(data => {
                        notes = data;   //後端NoteController回傳的JSON塞進notes
                        renderMainApp();    //重新渲染UI
                    })
                    .catch(err => {
                        console.error("取得筆記失敗:", err);
                        renderMainApp();
                    });
            }
        };

    </script>
</body>
</html>